name: 版本比对后自动打包并更新仓库

on:
  workflow_dispatch:  # 手动触发
  schedule:
    - cron: '0 0 * * *'  # 每日UTC 0点（北京时间8点）执行

env:
  APP_NAME: "fpk-zflie"
  APP_DISPLAY_NAME: "ZFile"
  APP_SOURCE_REPO: "zhaojun1998/https://github.com/zfile-dev/zfile"
  APP_TYPE: "Docker"
  DOCKER_REPO: "zhaojun1998/zfile"

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: read
    timeout-minutes: 15
    defaults:
      run:
        shell: bash
        working-directory: .
    steps:
      # ===================== 环境准备 =====================
      - name: 1. 检出代码
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: 2. 安装依赖
        run: |
          sudo apt update && sudo apt install -y jq curl sed skopeo coreutils findutils
          for tool in jq curl sed skopeo; do
            if ! command -v $tool &>/dev/null; then
              echo "❌ $tool 安装失败"
              exit 1
            fi
          done
          echo "✅ 依赖安装完成"

      - name: 3. 配置Git身份
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global core.autocrlf false
          git config --global pull.rebase false
          echo "✅ Git配置完成"

      # ===================== 版本比对核心逻辑 =====================
      - name: 4. 读取本地manifest版本号（强化换行符处理）
        id: local_ver
        run: |
          if [ -f "${{ env.APP_NAME }}/manifest" ]; then
            # 强化处理：使用dos2unix移除Windows换行符，再彻底清理空白字符
            LOCAL_VERSION=$(sed -n 's/^[[:space:]]*version[[:space:]]*[:=][[:space:]]*//p' "${{ env.APP_NAME }}/manifest" \
              | tr -d '"' | tr -d "'" \
              | sed 's/^v//' \
              | dos2unix \  # 移除可能的\r换行符
              | tr -d '\n' \  # 移除所有换行符
              | tr -d '\r' \  # 单独处理回车符
              | xargs)  # 清除首尾空格
            echo "本地manifest版本：[$LOCAL_VERSION]"
            echo "local_version=$LOCAL_VERSION" >> $GITHUB_OUTPUT
          else
            echo "❌ 未找到${{ env.APP_NAME }}/manifest，强制触发更新"
            echo "local_version=0.0.0" >> $GITHUB_OUTPUT
            mkdir -p "${{ env.APP_NAME }}"
            echo "version: 0.0.0" > "${{ env.APP_NAME }}/manifest"
            git add "${{ env.APP_NAME }}/manifest"
            git commit -m "chore: 初始化${{ env.APP_NAME }}的manifest文件" || echo "无需要提交的变更"
          fi

      - name: 5. 获取远程版本和哈希
        id: remote_ver
        run: |
          set -euo pipefail
          API_URL="https://registry.hub.docker.com/v2/repositories/${{ env.DOCKER_REPO }}/tags"
          RAW_RESPONSE=$(curl -s "$API_URL")
          
          ALL_VALID_TAGS=$(echo "$RAW_RESPONSE" | jq -r '.results[] | .name' \
            | grep -v -E '^latest$|^dev$|^beta$|^alpha$|^nightly$|^test$' \
            | grep -E '^[0-9]+\.[0-9]+(\.[0-9]+)?$')
          
          if [ -z "$ALL_VALID_TAGS" ]; then
            echo "❌ 未找到有效标签"
            exit 1
          fi
          
          # 版本排序
          SORTED_TAGS=$(echo "$ALL_VALID_TAGS" | while read -r tag; do
            ver=$tag
            [[ "$ver" =~ ^[0-9]+\.[0-9]+$ ]] && ver="$ver.0"
            echo "$ver|$tag"
          done | sort -t. -k1,1n -k2,2n -k3,3n)
          
          LATEST_TAG=$(echo "$SORTED_TAGS" | tail -n1 | cut -d'|' -f2)
          REMOTE_VERSION=$LATEST_TAG
          
          # 获取哈希
          REMOTE_DIGEST=$(echo "$RAW_RESPONSE" | jq -r --arg tag "$LATEST_TAG" \
            '.results[] | select(.name == $tag) | .images[0].digest // ""' \
            | tr -d '\n' | xargs)
          
          if [ -z "$REMOTE_DIGEST" ] || [ "$REMOTE_DIGEST" = "null" ]; then
            REMOTE_DIGEST=$(skopeo inspect --format '{{.Digest}}' \
              docker://${{ env.DOCKER_REPO }}:${LATEST_TAG} 2>/dev/null \
              | tr -d '\n' | xargs || echo "")
          fi
          
          echo "✅ 最新版本：[$REMOTE_VERSION]，哈希：[${REMOTE_DIGEST:0:12}...]"
          echo "remote_version=$REMOTE_VERSION" >> $GITHUB_OUTPUT
          echo "remote_digest=$REMOTE_DIGEST" >> $GITHUB_OUTPUT

      - name: 6. 读取本地哈希
        id: local_digest
        run: |
          set -euo pipefail
          DIGEST_FILE="docker-image-digest.txt"
          
          [ ! -f "$DIGEST_FILE" ] && touch "$DIGEST_FILE"
          LOCAL_DIGEST=$(cat "$DIGEST_FILE" | tr -d '\n' | tr -d '\r' | xargs || echo "")
          echo "本地哈希：[${LOCAL_DIGEST:0:12}...]"
          echo "local_digest=$LOCAL_DIGEST" >> $GITHUB_OUTPUT

      - name: 7. 版本+哈希比对（优化判断逻辑）
        id: compare
        run: |
          set -euo pipefail
          LOCAL_VER="${{ steps.local_ver.outputs.local_version }}"
          REMOTE_VER="${{ steps.remote_ver.outputs.remote_version }}"
          LOCAL_DIG="${{ steps.local_digest.outputs.local_digest }}"
          REMOTE_DIG="${{ steps.remote_ver.outputs.remote_digest }}"
          
          echo -e "\n🔍 版本比对："
          echo "本地版本: [$LOCAL_VER] (长度: ${#LOCAL_VER})"
          echo "远程版本: [$REMOTE_VER] (长度: ${#REMOTE_VER})"
          echo "本地哈希: [$LOCAL_DIG]"
          echo "远程哈希: [$REMOTE_DIG]"
          
          # 严格匹配（包括空哈希场景）
          if [ "$LOCAL_VER" != "$REMOTE_VER" ] || [ "$LOCAL_DIG" != "$REMOTE_DIG" ]; then
            echo "✅ 需要更新（版本或哈希不匹配）"
            echo "need_update=true" >> $GITHUB_OUTPUT
          else
            echo "✅ 无需更新（版本和哈希完全一致）"
            echo "need_update=false" >> $GITHUB_OUTPUT
          fi

      # ===================== 更新与推送流程 =====================
      - name: 8. 更新manifest和哈希文件
        if: steps.compare.outputs.need_update == 'true'
        run: |
          set -euo pipefail
          MANIFEST_PATH="${{ env.APP_NAME }}/manifest"
          DIGEST_FILE="docker-image-digest.txt"
          NEW_VER="${{ steps.remote_ver.outputs.remote_version }}"
          NEW_DIG="${{ steps.remote_ver.outputs.remote_digest }}"
          
          # 更新版本号（确保无换行）
          sed -i -E "s/(^[[:space:]]*version[[:space:]]*[:=][[:space:]]*)([\"']?).*([\"']?)/\1\2${NEW_VER}\3/" "$MANIFEST_PATH"
          
          # 写入哈希（确保无换行）
          echo -n "$NEW_DIG" > "$DIGEST_FILE"
          
          # 验证更新结果
          echo -e "\n✅ 更新验证："
          echo "manifest版本: [$(grep -i version "$MANIFEST_PATH" | sed 's/.*=//' | tr -d ' "' | xargs)]"
          echo "哈希文件内容: [$(cat "$DIGEST_FILE")]"
          git add "$MANIFEST_PATH" "$DIGEST_FILE"

      # 后续步骤（9-18）保持不变，此处省略...
