name: ç‰ˆæœ¬æ¯”å¯¹åè‡ªåŠ¨æ‰“åŒ…å¹¶æ›´æ–°ä»“åº“

on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘
  schedule:
    - cron: '0 0 * * *'  # æ¯æ—¥UTC 0ç‚¹ï¼ˆåŒ—äº¬æ—¶é—´8ç‚¹ï¼‰æ‰§è¡Œ

env:
  # æ ¸å¿ƒå‚æ•°ï¼šåº”ç”¨åç§°ï¼ˆåŸfpk-napcatqqï¼‰ï¼Œç»Ÿä¸€ä¿®æ”¹æ­¤å¤„å³å¯
  APP_NAME: "fpk-zflie"
  # åº”ç”¨æ˜¾ç¤ºåç§°ï¼ˆç”¨äºREADMEï¼‰
  APP_DISPLAY_NAME: "ZFile"
  # æ¥æºä»“åº“åœ°å€
  APP_SOURCE_REPO: "zhaojun1998/https://github.com/zfile-dev/zfile"
  # åº”ç”¨ç±»å‹
  APP_TYPE: "Docker"
  # Dockeré•œåƒä»“åº“
  DOCKER_REPO: "zhaojun1998/zfile"

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # æˆäºˆå†™å…¥ä»“åº“/åˆ›å»ºReleaseæƒé™
      pull-requests: read
    timeout-minutes: 15  # è¶…æ—¶ä¿æŠ¤ï¼ˆæ‰“åŒ…æµç¨‹è€—æ—¶è¾ƒé•¿ï¼‰
    defaults:
      run:
        shell: bash
        working-directory: .
    steps:
      # ===================== ç¬¬ä¸€æ­¥ï¼šç¯å¢ƒå‡†å¤‡ =====================
      - name: 1. æ£€å‡ºå½“å‰ä»“åº“ä»£ç ï¼ˆå¸¦å®Œæ•´å†å²ï¼‰
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # å®Œæ•´æ£€å‡ºå†å²
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: 2. å®‰è£…åŸºç¡€ä¾èµ–ï¼ˆå¢å¼ºç‰ˆï¼‰
        run: |
          sudo apt update && sudo apt install -y \
            jq curl sed skopeo coreutils findutils  # è¡¥å……åŸºç¡€å·¥å…·
          # éªŒè¯ä¾èµ–å®‰è£…
          for tool in jq curl sed skopeo; do
            if ! command -v $tool &>/dev/null; then
              echo "âŒ $tool å®‰è£…å¤±è´¥"
              exit 1
            fi
          done
          echo "âœ… æ‰€æœ‰åŸºç¡€ä¾èµ–å®‰è£…å®Œæˆ"

      - name: 3. é…ç½®Gitå…¨å±€èº«ä»½ï¼ˆè·¨ä»“åº“é€šç”¨ï¼‰
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global core.autocrlf false  # é¿å…æ¢è¡Œç¬¦é—®é¢˜
          git config --global pull.rebase false     # é¿å…rebaseå†²çª
          echo "âœ… Gitèº«ä»½é…ç½®å®Œæˆ"

      # ===================== ç¬¬äºŒæ­¥ï¼šç‰ˆæœ¬æ¯”å¯¹ï¼ˆæ ¸å¿ƒå‰ç½®ï¼‰ =====================
      - name: 4. è¯»å–æœ¬åœ°manifestç‰ˆæœ¬å·ï¼ˆé²æ£’ç‰ˆï¼Œä¿®å¤æ¢è¡Œç¬¦é—®é¢˜ï¼‰
        id: local_ver
        run: |
          # ä½¿ç”¨ç¯å¢ƒå˜é‡APP_NAMEæ›¿ä»£ç¡¬ç¼–ç çš„fpk-napcatqq
          if [ -f "${{ env.APP_NAME }}/manifest" ]; then
            # å¼ºåˆ¶ç§»é™¤æ¢è¡Œç¬¦å’Œç©ºæ ¼ï¼Œç¡®ä¿æ— éšè—å­—ç¬¦
            LOCAL_VERSION=$(sed -n 's/^[[:space:]]*version[[:space:]]*[:=][[:space:]]*//p' "${{ env.APP_NAME }}/manifest" \
              | tr -d '"' | tr -d "'" | sed 's/^v//' \
              | tr -d '\n' | xargs)
            echo "æœ¬åœ°manifestç‰ˆæœ¬ï¼š[$LOCAL_VERSION]"  # å¸¦è¾¹ç•Œç¬¦æ£€æŸ¥
            echo "local_version=$LOCAL_VERSION" >> $GITHUB_OUTPUT
          else
            echo "âŒ æœªæ‰¾åˆ°${{ env.APP_NAME }}/manifestï¼Œå¼ºåˆ¶è§¦å‘æ›´æ–°"
            echo "local_version=0.0.0" >> $GITHUB_OUTPUT
            mkdir -p "${{ env.APP_NAME }}"
            echo "version: 0.0.0" > "${{ env.APP_NAME }}/manifest"
            git add "${{ env.APP_NAME }}/manifest"
            git commit -m "chore: åˆå§‹åŒ–${{ env.APP_NAME }}çš„manifestæ–‡ä»¶" || echo "æ— éœ€è¦æäº¤çš„å˜æ›´"
          fi

      # ===================== æ ¸å¿ƒé€»è¾‘ï¼šè·å–è¿œç¨‹ç‰ˆæœ¬å’Œå“ˆå¸Œ =====================
      - name: 5. ä»Docker HubåŸå§‹APIè·å–æœ€æ–°ç‰ˆæœ¬å·
        id: remote_ver
        run: |
          set -euo pipefail
          
          # ä½¿ç”¨ç¯å¢ƒå˜é‡DOCKER_REPOæ›¿ä»£ç¡¬ç¼–ç çš„é•œåƒä»“åº“
          API_URL="https://registry.hub.docker.com/v2/repositories/${{ env.DOCKER_REPO }}/tags"
          RAW_RESPONSE=$(curl -s "$API_URL")
          REMOTE_VERSION=""
          REMOTE_DIGEST=""
          TOTAL_TAGS=0
          
          echo "ğŸ“¡ ä»APIæå–${{ env.APP_NAME }}ç‰ˆæœ¬ä¿¡æ¯..."
          
          # ç»Ÿè®¡æ€»æ ‡ç­¾æ•°
          TOTAL_TAGS=$(echo "$RAW_RESPONSE" | jq -r '.count // 0')
          
          # æå–æœ‰æ•ˆæ ‡ç­¾ï¼ˆæ’é™¤æµ‹è¯•ç‰ˆï¼Œä¿ç•™vX.Y.Zæ ¼å¼ï¼‰
          ALL_VALID_TAGS=$(echo "$RAW_RESPONSE" | jq -r '.results[] | .name' \
            | grep -v -E '^latest$|^dev$|^beta$|^alpha$|^nightly$|^test$' \
            | grep -E '^v[0-9]+\.[0-9]+(\.[0-9]+)?$')
          
          # æ— æœ‰æ•ˆæ ‡ç­¾åˆ™ç»ˆæ­¢
          if [ -z "$ALL_VALID_TAGS" ]; then
            echo "âŒ æœªæ‰¾åˆ°${{ env.APP_NAME }}çš„æœ‰æ•ˆç‰ˆæœ¬æ ‡ç­¾ï¼Œç»ˆæ­¢æµç¨‹"
            exit 1
          fi
          
          # ç‰ˆæœ¬å·æ•°å­—æ’åºï¼ˆè¡¥å…¨X.Yä¸ºX.Y.0ï¼‰
          SORTED_TAGS=$(echo "$ALL_VALID_TAGS" | while read -r tag; do
            ver=${tag#v}
            [[ "$ver" =~ ^[0-9]+\.[0-9]+$ ]] && ver="$ver.0"
            echo "$ver|$tag"
          done | sort -t. -k1,1n -k2,2n -k3,3n)
          
          # å–æœ€æ–°ç‰ˆæœ¬æ ‡ç­¾
          LATEST_TAG=$(echo "$SORTED_TAGS" | tail -n1 | cut -d'|' -f2)
          REMOTE_VERSION="${LATEST_TAG#v}"
          
          # æå–é•œåƒå“ˆå¸Œï¼ˆå¤„ç†éšè—å­—ç¬¦ï¼‰
          REMOTE_DIGEST=$(echo "$RAW_RESPONSE" | jq -r --arg tag "$LATEST_TAG" \
            '.results[] | select(.name == $tag) | .images[0].digest // ""' \
            | tr -d '\n' | xargs)
          
          # å“ˆå¸Œå…œåº•
          if [ -z "$REMOTE_DIGEST" ] || [ "$REMOTE_DIGEST" = "null" ]; then
            REMOTE_DIGEST=$(skopeo inspect --format '{{.Digest}}' \
              docker://${{ env.DOCKER_REPO }}:${LATEST_TAG} 2>/dev/null \
              | tr -d '\n' | xargs || echo "")
          fi
          
          echo "âœ… æœ€æ–°ç‰ˆæœ¬ï¼š[$REMOTE_VERSION]ï¼Œå“ˆå¸Œï¼š[${REMOTE_DIGEST:0:12}...]"
          echo "remote_version=$REMOTE_VERSION" >> $GITHUB_OUTPUT
          echo "remote_digest=$REMOTE_DIGEST" >> $GITHUB_OUTPUT
          echo "total_tags=$TOTAL_TAGS" >> $GITHUB_OUTPUT

      - name: 6. è¯»å–æœ¬åœ°å“ˆå¸Œè®°å½•ï¼ˆä¿®å¤éšè—å­—ç¬¦ï¼‰
        id: local_digest
        run: |
          set -euo pipefail
          DIGEST_FILE="docker-image-digest.txt"
          
          [ ! -f "$DIGEST_FILE" ] && touch "$DIGEST_FILE"
          LOCAL_DIGEST=$(cat "$DIGEST_FILE" | tr -d '\n' | xargs || echo "")
          echo "æœ¬åœ°å“ˆå¸Œï¼š[${LOCAL_DIGEST:0:12}...]"
          echo "local_digest=$LOCAL_DIGEST" >> $GITHUB_OUTPUT

      - name: 7. ç‰ˆæœ¬+å“ˆå¸Œæ¯”å¯¹ï¼ˆç²¾ç¡®åˆ¤æ–­ï¼‰
        id: compare
        run: |
          set -euo pipefail
          LOCAL_VER="${{ steps.local_ver.outputs.local_version }}"
          REMOTE_VER="${{ steps.remote_ver.outputs.remote_version }}"
          LOCAL_DIG="${{ steps.local_digest.outputs.local_digest }}"
          REMOTE_DIG="${{ steps.remote_ver.outputs.remote_digest }}"
          
          echo -e "\nğŸ” åŸå§‹å€¼æ¯”å¯¹ï¼ˆå¸¦è¾¹ç•Œç¬¦ï¼‰ï¼š"
          echo "LOCAL_VER: [$LOCAL_VER]"
          echo "REMOTE_VER: [$REMOTE_VER]"
          echo "LOCAL_DIG: [$LOCAL_DIG]"
          echo "REMOTE_DIG: [$REMOTE_DIG]"
          
          # ç²¾ç¡®åˆ¤æ–­é€»è¾‘
          if [ "$LOCAL_VER" != "$REMOTE_VER" ] || { [ "$LOCAL_VER" = "$REMOTE_VER" ] && [ "$LOCAL_DIG" != "$REMOTE_DIG" ] && [ -n "$LOCAL_DIG" ] && [ -n "$REMOTE_DIG" ]; }; then
            echo "âœ… éœ€è¦æ›´æ–°ï¼ˆç‰ˆæœ¬æˆ–å“ˆå¸Œä¸ä¸€è‡´ï¼‰"
            echo "need_update=true" >> $GITHUB_OUTPUT
          else
            echo "âœ… æ— éœ€æ›´æ–°ï¼ˆç‰ˆæœ¬å’Œå“ˆå¸Œå®Œå…¨ä¸€è‡´ï¼‰"
            echo "need_update=false" >> $GITHUB_OUTPUT
          fi

      # ===================== ç¬¬ä¸‰æ­¥ï¼šä»…éœ€æ›´æ–°æ—¶æ‰§è¡Œ =====================
      - name: 8. æ›´æ–°manifest+å“ˆå¸Œè®°å½•
        if: steps.compare.outputs.need_update == 'true'
        run: |
          set -euo pipefail
          MANIFEST_PATH="${{ env.APP_NAME }}/manifest"
          DIGEST_FILE="docker-image-digest.txt"
          NEW_VER="${{ steps.remote_ver.outputs.remote_version }}"
          NEW_DIG="${{ steps.remote_ver.outputs.remote_digest }}"
          
          # æ›´æ–°ç‰ˆæœ¬å·ï¼ˆé¿å…å¤šä½™æ¢è¡Œï¼‰
          sed -i -E "s/(^[[:space:]]*version[[:space:]]*[:=][[:space:]]*)([\"']?).*([\"']?)/\1\2${NEW_VER}\3/" "$MANIFEST_PATH"
          
          # æ›´æ–°å“ˆå¸Œï¼ˆecho -n é¿å…æ¢è¡Œï¼‰
          echo -n "$NEW_DIG" > "$DIGEST_FILE"
          
          # éªŒè¯æ›´æ–°
          echo -e "\nâœ… æ›´æ–°ç»“æœéªŒè¯ï¼š"
          echo "manifestç‰ˆæœ¬: [$(grep -i version "$MANIFEST_PATH" | sed 's/.*=//' | tr -d ' "' | xargs)]"
          echo "å“ˆå¸Œè®°å½•: [$(cat "$DIGEST_FILE")]"
          git add "$MANIFEST_PATH" "$DIGEST_FILE"

      - name: 9. æäº¤å¹¶æ¨é€å˜æ›´
        if: steps.compare.outputs.need_update == 'true'
        run: |
          set -euo pipefail
          COMMIT_MSG="chore: æ›´æ–°${{ env.APP_NAME }}è‡³ç‰ˆæœ¬${{ steps.remote_ver.outputs.remote_version }}"
          
          git commit -m "$COMMIT_MSG" || echo "âœ… æ— å®é™…å˜æ›´éœ€æäº¤"
          git push origin HEAD:${{ github.ref_name }} || (
            git pull --rebase origin ${{ github.ref_name }} && git push origin HEAD:${{ github.ref_name }}
          )
          echo "âœ… å˜æ›´å·²æ¨é€è‡³ä»“åº“"

      - name: 10. ä¸‹è½½å¹¶å®‰è£…fnpack
        if: steps.compare.outputs.need_update == 'true'
        run: |
          curl -SL --retry 3 --connect-timeout 10 -o /usr/local/bin/fnpack \
            "https://static2.fnnas.com/fnpack/fnpack-1.0.4-linux-amd64"
          chmod +x /usr/local/bin/fnpack
          echo "âœ… fnpackå®‰è£…å®Œæˆï¼š$(fnpack --version 2>&1 | head -n1)"

      - name: 11. æ‰§è¡Œfnpackæ‰“åŒ…
        if: steps.compare.outputs.need_update == 'true'
        id: build_fpk
        run: |
          set -euo pipefail
          cd "${{ env.APP_NAME }}"
          fnpack build
          
          FPK_FILE=$(find . -name "*.fpk" -type f | head -n1)
          [ -z "$FPK_FILE" ] && { echo "âŒ æœªç”Ÿæˆ${{ env.APP_NAME }}çš„fpkæ–‡ä»¶"; exit 1; }
          
          VERSION="${{ steps.remote_ver.outputs.remote_version }}"
          ARCH="Linux-AMD64"
          FPK_VERSION_NAME="${{ env.APP_NAME }}-v${VERSION}-${ARCH}.fpk"
          mkdir -p /tmp/fpk_build
          cp "$FPK_FILE" "/tmp/fpk_build/$FPK_VERSION_NAME"
          
          echo "âœ… æ‰“åŒ…å®Œæˆï¼š/tmp/fpk_build/$FPK_VERSION_NAME"
          echo "fpk_release_file=/tmp/fpk_build/$FPK_VERSION_NAME" >> $GITHUB_OUTPUT
          echo "fpk_release_name=$FPK_VERSION_NAME" >> $GITHUB_OUTPUT

      # ===================== ç¬¬å››æ­¥ï¼šæ¨é€è‡³FnDepotä»“åº“ =====================
      - name: 12. å…‹éš†FnDepotä»“åº“
        if: steps.compare.outputs.need_update == 'true'
        run: |
          rm -rf /tmp/FnDepot
          git clone "https://${{ secrets.FnDepot_PAT }}@github.com/moxyis/FnDepot.git" /tmp/FnDepot
          echo "âœ… FnDepotä»“åº“å…‹éš†å®Œæˆ"

      - name: 13. å¤åˆ¶fpkæ–‡ä»¶åˆ°FnDepot
        if: steps.compare.outputs.need_update == 'true'
        run: |
          mkdir -p "/tmp/FnDepot/${{ env.APP_NAME }}"
          cp "${{ steps.build_fpk.outputs.fpk_release_file }}" "/tmp/FnDepot/${{ env.APP_NAME }}/"
          echo "âœ… ${{ env.APP_NAME }}çš„fpkæ–‡ä»¶å·²å¤åˆ¶åˆ°FnDepot"

      - name: 14. æ›´æ–°FnDepotçš„fnpack.json
        if: steps.compare.outputs.need_update == 'true'
        run: |
          set -euo pipefail
          VERSION="${{ steps.remote_ver.outputs.remote_version }}"
          JSON_FILE="/tmp/FnDepot/fnpack.json"
          
          # åˆå§‹åŒ–JSONæ–‡ä»¶ï¼ˆè‹¥ä¸å­˜åœ¨ï¼‰
          [ ! -f "$JSON_FILE" ] && echo '{}' > "$JSON_FILE"
          
          # æ›´æ–°ç‰ˆæœ¬å·ï¼ˆç¡®ä¿ç»“æ„æ­£ç¡®ï¼‰
          jq --arg app "${{ env.APP_NAME }}" --arg ver "$VERSION" \
            '.[$app] = (.[$app] // {}) | .[$app].version = $ver' \
            "$JSON_FILE" > "$JSON_FILE.tmp" && mv "$JSON_FILE.tmp" "$JSON_FILE"
          
          echo "âœ… fnpack.jsonæ›´æ–°å®Œæˆï¼š$(cat "$JSON_FILE")"

      - name: 15. æ›´æ–°FnDepotçš„README.mdï¼ˆä¿®å¤åŒ¹é…è§„åˆ™ï¼‰
        if: steps.compare.outputs.need_update == 'true'
        run: |
          set -euo pipefail
          VERSION="${{ steps.remote_ver.outputs.remote_version }}"
          README_FILE="/tmp/FnDepot/README.md"
          
          # åˆå§‹åŒ–READMEï¼ˆè‹¥ä¸å­˜åœ¨ï¼‰
          if [ ! -f "$README_FILE" ]; then
            echo "# FnDepot" > "$README_FILE"
            echo "" >> "$README_FILE"
            echo "| åº”ç”¨åç§°       | ç‰ˆæœ¬å·   | æ¥æºä»“åº“                                  | ç±»å‹   |" >> "$README_FILE"
            echo "|----------------|----------|-------------------------------------------|--------|" >> "$README_FILE"
            # ä½¿ç”¨ç¯å¢ƒå˜é‡å¡«å……åº”ç”¨ä¿¡æ¯
            echo "| **${{ env.APP_DISPLAY_NAME }}**   | $VERSION | ${{ env.APP_SOURCE_REPO }} | ${{ env.APP_TYPE }} |" >> "$README_FILE"
            echo "" >> "$README_FILE"
            echo "è‡ªåŠ¨æ›´æ–°è¯´æ˜ï¼šæ¯æ—¥åŒæ­¥æœ€æ–°ç‰ˆæœ¬" >> "$README_FILE"
            echo "âœ… åˆå§‹åŒ–README.mdå®Œæˆ"
          else
            # ä¿®å¤åŒ¹é…è§„åˆ™ï¼šä½¿ç”¨APP_DISPLAY_NAMEç²¾ç¡®åŒ¹é…
            sed -i -E \
              's/(^\|.*\*\*${{ env.APP_DISPLAY_NAME }}\*\*.*\|[[:space:]]*)[0-9.]+([[:space:]]*\|.*$)/\1'"${VERSION}"'\2/' \
              "$README_FILE"
            echo "âœ… README.mdç‰ˆæœ¬å·å·²æ›´æ–°ä¸ºï¼š$VERSION"
          fi
          
          # éªŒè¯æ›´æ–°ç»“æœ
          echo -e "\nğŸ“„ README.mdå…³é”®å†…å®¹ï¼š"
          grep -A 1 "${{ env.APP_DISPLAY_NAME }}" "$README_FILE"

      - name: 16. æäº¤å¹¶æ¨é€FnDepotå˜æ›´
        if: steps.compare.outputs.need_update == 'true'
        run: |
          set -euo pipefail
          cd /tmp/FnDepot
          
          # æš‚å­˜å˜æ›´
          git add "${{ env.APP_NAME }}/" fnpack.json README.md
          
          # æäº¤
          COMMIT_MSG="chore: æ›´æ–°${{ env.APP_NAME }}è‡³v${{ steps.remote_ver.outputs.remote_version }}"
          git commit -m "$COMMIT_MSG" || echo "âœ… FnDepotæ— å˜æ›´"
          
          # æ¨é€ï¼ˆå¸¦é‡è¯•ï¼‰
          git push origin main || (
            echo "âš ï¸ æ¨é€å¤±è´¥ï¼Œå°è¯•æ‹‰å–åé‡è¯•" &&
            git pull --rebase origin main &&
            git push origin main
          )
          echo "âœ… FnDepotä»“åº“æ›´æ–°å®Œæˆ"

      # ===================== ç¬¬äº”æ­¥ï¼šåˆ›å»ºGitHub Release =====================
      - name: 17. åˆ›å»ºReleaseå¹¶ä¸Šä¼ æ–‡ä»¶
        if: steps.compare.outputs.need_update == 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "v${{ steps.remote_ver.outputs.remote_version }}"
          name: "${{ env.APP_NAME }} v${{ steps.remote_ver.outputs.remote_version }}"
          body: |
            ## è‡ªåŠ¨æ›´æ–°è¯´æ˜
            - åº”ç”¨åç§°ï¼š${{ env.APP_NAME }}ï¼ˆ${{ env.APP_DISPLAY_NAME }}ï¼‰
            - ç‰ˆæœ¬ï¼šv${{ steps.remote_ver.outputs.remote_version }}
            - æ¶æ„ï¼šLinux-AMD64
            - å“ˆå¸Œï¼š${{ steps.remote_ver.outputs.remote_digest }}
            - æ›´æ–°æ—¶é—´ï¼š${{ github.run_at }}
          files: ${{ steps.build_fpk.outputs.fpk_release_file }}
          overwrite: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # ===================== ç¬¬å…­æ­¥ï¼šå¼‚å¸¸æ—¥å¿—ä¸Šä¼  =====================
      - name: 18. ä¸Šä¼ è°ƒè¯•æ—¥å¿—ï¼ˆå¤±è´¥æ—¶ï¼‰
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: debug-logs-${{ github.run_id }}
          path: |
            ${{ env.APP_NAME }}/manifest
            docker-image-digest.txt
            /tmp/fpk_build/*
            /tmp/FnDepot/README.md
          retention-days: 7
